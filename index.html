<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BarberApp Premium</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-gold: #D4AF37;
            --bg-dark: #121212;
            --card-dark: #1E1E1E;
            --text-light: #ffffff;
            --text-muted: #cccccc;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Open Sans', sans-serif;
            font-size: 16px;
        }

        /* Navbar Fixa no Topo */
        .navbar {
            background: #1E1E1E;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            padding: 10px 0;
            z-index: 1000;
        }
        .navbar-brand {
            color: var(--primary-gold) !important;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Ajuste para o conte√∫do n√£o ficar atr√°s da navbar */
        .main-container {
            margin-top: 20px;
            padding-bottom: 80px;
        }

        /* Cards e Inputs */
        .card {
            background-color: var(--card-dark);
            border: 1px solid #333;
            border-radius: 12px;
        }

        label { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 5px; }

        .form-control, .form-select {
            background-color: #2C2C2C;
            border: 1px solid #444;
            color: #fff !important;
            font-size: 1rem;
            border-radius: 8px;
            padding: 12px;
        }
        .form-control:focus, .form-select:focus {
            background-color: #333;
            border-color: var(--primary-gold);
            color: #fff !important;
            box-shadow: none;
        }

        /* Bot√µes */
        .btn-gold {
            background: var(--primary-gold);
            border: none;
            color: #000;
            font-weight: 700;
            text-transform: uppercase;
        }
        .btn-gold:hover { background: #b59024; color: #000; }

        /* Abas Estilizadas */
        .nav-tabs { border-bottom: 1px solid #333; margin-bottom: 20px; }
        .nav-link { 
            color: var(--text-muted); 
            border: none; 
            font-weight: 600; 
            padding: 12px;
        }
        .nav-link.active {
            background-color: transparent !important;
            color: var(--primary-gold) !important;
            border-bottom: 3px solid var(--primary-gold) !important;
        }
        .nav-link:hover { color: var(--primary-gold); }

        /* Utilit√°rios */
        .hidden { display: none !important; }
        .text-gold { color: var(--primary-gold) !important; }
        
        /* Lista e Tabela */
        .list-group-item {
            background-color: #252525;
            border: 1px solid #333;
            color: var(--text-light);
            margin-bottom: 8px;
            border-radius: 8px !important;
        }
        
        .table { --bs-table-color: var(--text-muted); }
        .table-dark { --bs-table-bg: #252525; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0"><i class="bi bi-scissors"></i> Barber<span class="text-white">App</span></span>
        <button id="btnSair" class="btn btn-outline-light btn-sm rounded-pill px-3 hidden" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Sair
        </button>
    </div>
</nav>

<div class="container main-container">

    <div id="loginScreen" class="card p-4 mx-auto mt-5" style="max-width: 400px;">
        <div class="text-center mb-4">
            <h1 class="text-gold"><i class="bi bi-person-lock"></i></h1>
            <h4>Acesso Restrito</h4>
            <p class="text-muted small">Use seu email e senha cadastrados</p>
        </div>
        
        <form onsubmit="fazerLogin(event)">
            <div class="mb-3">
                <label>Email</label>
                <input type="email" id="emailLogin" class="form-control" placeholder="ex: dono@barber.com" required>
            </div>
            <div class="mb-4">
                <label>Senha</label>
                <input type="password" id="senhaLogin" class="form-control" placeholder="******" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-gold py-3 rounded-pill shadow">
                    Entrar
                </button>
            </div>
            <div id="loginError" class="text-danger text-center mt-3 small hidden"></div>
        </form>
    </div>

    <div id="mainPanel" class="hidden fade-in">
        
        <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="lancar-tab" data-bs-toggle="tab" data-bs-target="#lancar" type="button" role="tab">
                    <i class="bi bi-plus-circle"></i> Lan√ßar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="relatorio-tab" data-bs-toggle="tab" data-bs-target="#relatorio" type="button" role="tab">
                    <i class="bi bi-graph-up"></i> Relat√≥rio
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="chatbot-tab" data-bs-toggle="tab" data-bs-target="#chatbot" type="button" role="tab">
                    <i class="bi bi-whatsapp"></i> Pedidos <span id="chatBadge" class="badge bg-danger rounded-pill ms-1">0</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="lancar" role="tabpanel">
                <div class="card p-4">
                    <h5 class="mb-4 text-gold border-bottom border-secondary pb-2">Novo Corte / Servi√ßo</h5>
                    <form onsubmit="salvarServico(event)">
                        <div class="mb-3">
                            <label>Nome do Cliente</label>
                            <input type="text" id="clienteNome" class="form-control" placeholder="Digite o nome..." required>
                        </div>
                        <div class="mb-3">
                            <label>Servi√ßo</label>
                            <select id="tipoServico" class="form-select">
                                <option value="Corte Degrad√™">‚úÇÔ∏è Corte Degrad√™</option>
                                <option value="Corte Social">‚úÇÔ∏è Corte Social</option>
                                <option value="Barba">ü™í Barba</option>
                                <option value="Corte + Barba">‚≠ê Corte + Barba</option>
                                <option value="Sobrancelha">üìê Sobrancelha</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label>Valor (R$)</label>
                            <input type="number" id="valorServico" class="form-control" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-gold py-3 rounded-pill">Confirmar Lan√ßamento</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="relatorio" role="tabpanel">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="card p-3 text-center bg-dark border-secondary h-100">
                            <small class="text-muted fw-bold">Colaborador (60%)</small>
                            <h3 class="text-success mt-2">R$ <span id="totalColab">0.00</span></h3>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card p-3 text-center bg-dark border-secondary h-100">
                            <small class="text-muted fw-bold">Casa (40%)</small>
                            <h3 class="text-gold mt-2">R$ <span id="totalCasa">0.00</span></h3>
                        </div>
                    </div>
                </div>
                
                <div class="card p-3">
                    <h6 class="text-white mb-3">Hist√≥rico do Dia</h6>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-sm align-middle mb-0">
                            <thead>
                                <tr class="text-muted">
                                    <th>Cli.</th>
                                    <th>Serv.</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="listaHistorico">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="chatbot" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-white mb-0">Fila de Espera</h5>
                    <span class="badge bg-success"><i class="bi bi-whatsapp"></i> Online</span>
                </div>
                <div id="chatbotList" class="list-group">
                    </div>
                <p class="text-center text-muted mt-3 small">Aguardando novos pedidos...</p>
            </div>

        </div> </div> </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    // Importa√ß√µes do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    // --- CONFIGURA√á√ÉO (J√° com suas chaves) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDcIDq8AEmL48Z9IFy7-fzBTY6yiFTzTL4",
        authDomain: "appbarber-cf462.firebaseapp.com",
        projectId: "appbarber-cf462",
        storageBucket: "appbarber-cf462.firebasestorage.app",
        messagingSenderId: "252056091488",
        appId: "1:252056091488:web:8a483735cf8186ce24bc05",
        measurementId: "G-8L2WJPVW6G"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const colecaoVendas = collection(db, "lancamentos");

    // --- Monitorar Estado do Login (Entra sozinho se j√° logou antes) ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Usu√°rio est√° logado
            console.log("Logado como:", user.email);
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainPanel').classList.remove('hidden');
            document.getElementById('btnSair').classList.remove('hidden');
            iniciarEscutaEmTempoReal();
            carregarChatbotMock();
        } else {
            // Usu√°rio n√£o est√° logado
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainPanel').classList.add('hidden');
            document.getElementById('btnSair').classList.add('hidden');
        }
    });

    // --- Fun√ß√£o de Login (Conectada ao Form) ---
    window.fazerLogin = function(e) {
        e.preventDefault();
        const email = document.getElementById('emailLogin').value;
        const pass = document.getElementById('senhaLogin').value;
        const errorMsg = document.getElementById('loginError');

        errorMsg.classList.add('hidden');
        
        signInWithEmailAndPassword(auth, email, pass)
            .then((userCredential) => {
                // Sucesso! O onAuthStateChanged vai cuidar de mudar a tela
            })
            .catch((error) => {
                console.error(error);
                errorMsg.innerText = "Erro: Email ou senha incorretos.";
                errorMsg.classList.remove('hidden');
            });
    }

    // --- Fun√ß√£o de Logout ---
    window.logout = function() {
        signOut(auth).then(() => {
            // O onAuthStateChanged vai jogar pra tela de login
            location.reload(); 
        }).catch((error) => {
            console.error(error);
        });
    }

    // --- Salvar Venda no Banco ---
    window.salvarServico = async function(e) {
        e.preventDefault();
        
        const cliente = document.getElementById('clienteNome').value;
        const servico = document.getElementById('tipoServico').value;
        const valorTotal = parseFloat(document.getElementById('valorServico').value);

        if(!cliente || !valorTotal) return;

        const parteColaborador = valorTotal * 0.60;
        const parteCasa = valorTotal * 0.40;

        try {
            await addDoc(colecaoVendas, {
                cliente: cliente,
                servico: servico,
                total: valorTotal,
                colab: parteColaborador,
                casa: parteCasa,
                user_email: auth.currentUser.email, // Salva quem fez o corte
                data: Timestamp.now()
            });
            alert("‚úÖ Lan√ßado com sucesso!");
            document.getElementById('clienteNome').value = '';
            document.getElementById('valorServico').value = '';
            
            // Foca de novo no primeiro campo
            document.getElementById('clienteNome').focus();

        } catch (error) {
            alert("Erro ao salvar: " + error.message);
        }
    }

    // --- Atualizar Relat√≥rio em Tempo Real ---
    function iniciarEscutaEmTempoReal() {
        const q = query(colecaoVendas, orderBy("data", "asc"));

        onSnapshot(q, (snapshot) => {
            let totalC = 0;
            let totalH = 0;
            const tbody = document.getElementById('listaHistorico');
            tbody.innerHTML = '';

            const vendas = [];
            snapshot.forEach((doc) => {
                vendas.push({ id: doc.id, ...doc.data() });
            });

            // Mostra os mais recentes no topo
            vendas.reverse().forEach(item => {
                totalC += item.colab;
                totalH += item.casa;

                let row = `<tr>
                    <td class="text-white">${item.cliente}</td>
                    <td class="text-muted small">${item.servico}</td>
                    <td class="text-gold">R$${item.total.toFixed(0)}</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            document.getElementById('totalColab').innerText = totalC.toFixed(2);
            document.getElementById('totalCasa').innerText = totalH.toFixed(2);
        });
    }

    // --- Mock Chatbot (Exemplo) ---
    window.carregarChatbotMock = function() {
        const pedidos = [
            { cliente: "Carlos (Zap)", servico: "Barba + Corte", hora: "14:30" },
            { cliente: "Ana (Bot)", servico: "Sobrancelha", hora: "15:00" }
        ];
        const lista = document.getElementById('chatbotList');
        const badge = document.getElementById('chatBadge');
        
        if(lista) {
            lista.innerHTML = '';
            pedidos.forEach(p => {
                lista.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                        <div>
                            <div class="fw-bold text-white">${p.cliente}</div>
                            <div class="small text-muted">${p.servico} - ${p.hora}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-success rounded-pill" onclick="importarPedido('${p.cliente}', '${p.servico}')">
                            Lan√ßar
                        </button>
                    </div>`;
            });
            badge.innerText = pedidos.length;
        }
    }

    window.importarPedido = function(nome, servico) {
        document.getElementById('clienteNome').value = nome;
        // Ativa a aba de lan√ßar via JS do Bootstrap 5
        const triggerEl = document.querySelector('#lancar-tab');
        const tab = new bootstrap.Tab(triggerEl);
        tab.show();
        document.getElementById('valorServico').focus();
    }
</script>

</body>
</html>
