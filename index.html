<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barbearia Merigio - Admin Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        :root {
            --gold-bright: #FFD700; 
            --bg-dark: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-white: #ffffff;
            --status-open: #00ff88;
            --status-closed: #ff4444;
            --status-blocked: #ffae00;
        }
        body { background-color: var(--bg-dark); color: var(--text-white); font-family: 'Roboto', sans-serif; font-size: 16px; }
        
        .navbar { background-color: #000; border-bottom: 2px solid var(--gold-bright); padding: 15px 0; }
        .navbar-brand { font-family: 'Montserrat', sans-serif; font-weight: 800; color: var(--gold-bright) !important; font-size: 1.4rem; text-transform: uppercase; }
        
        .card { background-color: var(--card-bg); border: 1px solid #444; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .form-control, .form-select { background-color: #fff !important; color: #000 !important; border: 2px solid #999; font-weight: 600; padding: 10px; border-radius: 8px; }
        .btn-gold { background-color: var(--gold-bright); color: #000; font-weight: 800; padding: 12px; border: none; width: 100%; text-transform: uppercase; }
        
        .nav-tabs { border-bottom: 1px solid #555; }
        .nav-tabs .nav-link { color: #ffffff; font-weight: bold; padding: 15px; font-size: 1.1rem; text-transform: uppercase; }
        .nav-tabs .nav-link.active { background-color: transparent !important; color: var(--gold-bright) !important; border-bottom: 4px solid var(--gold-bright) !important; }
        
        .status-toggle { font-size: 0.8rem; padding: 5px 12px; border-radius: 20px; border: 1px solid #555; cursor: pointer; font-weight: bold; }
        .status-on { background: var(--status-open); color: black; }
        .status-off { background: var(--status-closed); color: white; }

        /* CARDS AGENDA */
        .slot-card { background: #333; border: 1px solid #444; padding: 12px; margin-bottom: 12px; border-radius: 10px; position: relative; overflow: hidden; }
        .slot-livre { border-left: 5px solid var(--status-open); }
        .slot-ocupado { border-left: 5px solid var(--status-closed); }
        .slot-bloqueado { border-left: 5px solid var(--status-blocked); background: #3b3020; }
        
        .info-row { display: flex; justify-content: space-between; align-items: center; }
        .time-badge { font-size: 1.2rem; font-weight: 800; color: #fff; }
        .client-info { font-size: 1rem; color: #fff; margin-top: 5px; font-weight: bold; }
        .phone-info { font-size: 0.9rem; color: #aaa; }
        .service-info { font-size: 0.85rem; color: var(--gold-bright); font-weight: 600; margin-top: 4px; }
        
        .btn-cancel { background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid #ff4444; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        .btn-block { background: rgba(255, 174, 0, 0.2); color: #ffae00; border: 1px solid #ffae00; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        
        .btn-launch { background: var(--status-open); color: #000; border: none; padding: 5px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: bold; margin-right: 5px; box-shadow: 0 0 10px rgba(0,255,136,0.3); }
        
        /* BOT√ïES DE SERVI√áO */
        .service-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn-service {
            background: #333; color: #fff; border: 1px solid #555; padding: 12px 5px; 
            border-radius: 10px; font-weight: bold; text-align: center; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-service small { font-size: 0.75rem; color: #aaa; margin-top: 3px; }
        .btn-service.active {
            background: var(--gold-bright); color: #000; border-color: var(--gold-bright);
            transform: scale(1.02); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        .btn-service.active small { color: #333; }

        /* LISTA DETALHADA DE ITENS */
        #listaItensEdicao { background: #222; border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid #444; }
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .item-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .item-name { font-size: 0.9rem; color: #ddd; flex-grow: 1; }
        .item-price-input { width: 90px; background: #fff; color: #000; border: none; border-radius: 5px; padding: 5px; font-weight: bold; text-align: right; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0">BARBEARIA <span class="text-white">MERIGIO</span></span>
        <div id="lojaStatusContainer" class="hidden">
            <button id="btnStatusLoja" class="btn btn-sm status-toggle status-on" onclick="alternarStatusLoja()">ABERTO</button>
        </div>
    </div>
</nav>

<div class="container mt-3 pb-5">
    <div id="loginScreen" class="card p-4 mx-auto mt-4" style="max-width: 400px;">
        <div class="text-center mb-4"><h2 class="text-gold">LOGIN</h2></div>
        <form onsubmit="fazerLogin(event)">
            <div class="mb-3"><label class="text-muted small">EMAIL</label><input type="email" id="emailLogin" class="form-control" required></div>
            <div class="mb-4"><label class="text-muted small">SENHA</label><input type="password" id="senhaLogin" class="form-control" required></div>
            <button type="submit" class="btn btn-gold rounded-3">ACESSAR SISTEMA</button>
        </form>
    </div>

    <div id="mainPanel" class="hidden">
        <ul class="nav nav-tabs nav-fill mb-3" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda">AGENDA</button></li>
            <li class="nav-item"><button class="nav-link" id="lancar-tab" data-bs-toggle="tab" data-bs-target="#lancar">LAN√áAR</button></li>
            <li class="nav-item"><button class="nav-link" id="relatorio-tab" data-bs-toggle="tab" data-bs-target="#relatorio">CAIXA</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="agenda">
                <div class="card p-3">
                    <h5 class="text-white mb-3">Agenda de Hoje</h5>
                    <div id="listaHorarios"><p class="text-center text-muted">Carregando...</p></div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="lancar">
                <div class="card p-3">
                    <form onsubmit="salvarServico(event)">
                        
                        <div class="mb-3"><label class="text-gold fw-bold small">QUEM ATENDEU?</label>
                            <select id="profissionalSelect" class="form-select">
                                <option value="Fernando">üëë FERNANDO</option>
                                <option value="Denver">‚úÇÔ∏è DENVER</option>
                            </select>
                        </div>
                        <div class="mb-3"><label class="text-muted small">NOME CLIENTE</label><input type="text" id="clienteNome" class="form-control" required></div>
                        
                        <div class="mb-2"><label class="text-muted small">TOQUE PARA ADICIONAR:</label></div>
                        <div class="service-grid">
                            <div class="btn-service" id="btn-corte" onclick="toggleServico(this, 'Corte', 35)">‚úÇÔ∏è Corte <small>R$ 35</small></div>
                            <div class="btn-service" id="btn-degrade" onclick="toggleServico(this, 'Degrad√™', 40)">üìè Degrad√™ <small>R$ 40</small></div>
                            <div class="btn-service" id="btn-barba" onclick="toggleServico(this, 'Barba', 30)">ü™í Barba <small>R$ 30</small></div>
                            <div class="btn-service" id="btn-sobranc" onclick="toggleServico(this, 'Sobrancelha', 15)">üìê Sobranc. <small>R$ 15</small></div>
                            <div class="btn-service" id="btn-pezinho" onclick="toggleServico(this, 'Pezinho', 10)">‚ú® Pezinho <small>R$ 10</small></div>
                            <div class="btn-service" id="btn-outro" onclick="toggleServico(this, 'Outro', 0)">‚ûï Outro <small>Digitar</small></div>
                        </div>

                        <div id="containerItens" class="hidden">
                            <div class="mb-2"><label class="text-muted small">ITENS SELECIONADOS (EDITE O PRE√áO):</label></div>
                            <div id="listaItensEdicao">
                                </div>
                        </div>

                        <div class="mb-4">
                            <label class="text-gold fw-bold small">TOTAL FINAL (R$)</label>
                            <input type="number" id="valorServico" class="form-control fw-bold" style="font-size: 1.5rem;" readonly required>
                        </div>

                        <button type="submit" class="btn btn-gold rounded-3 shadow py-3">CONFIRMAR LAN√áAMENTO</button>
                    </form>
                </div>
            </div>
            
            <div class="tab-pane fade" id="relatorio">
                <div class="row g-2 mb-3">
                    <div class="col-6"><div class="card p-3 text-center border-success"><small class="fw-bold text-muted">DENVER</small><h3 class="text-success" id="saldoDenver">0</h3></div></div>
                    <div class="col-6"><div class="card p-3 text-center border-warning"><small class="fw-bold text-muted">FERNANDO</small><h3 class="text-warning" id="saldoFernando">0</h3></div></div>
                </div>
                <div class="card p-2">
                    <table class="table table-dark table-striped mb-0 table-sm">
                        <thead><tr class="text-muted small"><th>Prof.</th><th>Cliente/Detalhes</th><th class="text-end">Valor</th></tr></thead>
                        <tbody id="listaHistorico"></tbody>
                    </table>
                </div>
            </div>
        </div> 
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, deleteDoc, setDoc, onSnapshot, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDcIDq8AEmL48Z9IFy7-fzBTY6yiFTzTL4",
        authDomain: "appbarber-cf462.firebaseapp.com",
        projectId: "appbarber-cf462",
        storageBucket: "appbarber-cf462.firebasestorage.app",
        messagingSenderId: "252056091488",
        appId: "1:252056091488:web:8a483735cf8186ce24bc05"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const colVendas = collection(db, "lancamentos");
    const colAgenda = collection(db, "agendamentos");
    const docConfig = doc(db, "configuracao", "status_loja");

    function getDataHoje() { return new Date().toLocaleDateString('fr-CA', { timeZone: 'America/Sao_Paulo' }); }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainPanel').classList.remove('hidden');
            document.getElementById('lojaStatusContainer').classList.remove('hidden');
            iniciarAgenda();
            iniciarFinanceiro();
            monitorarStatus();
        }
    });

    window.fazerLogin = (e) => {
        e.preventDefault();
        signInWithEmailAndPassword(auth, document.getElementById('emailLogin').value, document.getElementById('senhaLogin').value).catch(err => alert("Erro: " + err.message));
    }

    // --- NOVA L√ìGICA DE ITENS EDIT√ÅVEIS ---
    
    window.toggleServico = function(btnElement, nomeServico, valorPadrao) {
        btnElement.classList.toggle('active');
        const container = document.getElementById('listaItensEdicao');
        const boxContainer = document.getElementById('containerItens');
        const idLimpo = nomeServico.replace(/\s+/g, '-').toLowerCase(); // ID √∫nico (ex: corte)

        if (btnElement.classList.contains('active')) {
            // Adiciona Linha de Edi√ß√£o
            boxContainer.classList.remove('hidden');
            
            const div = document.createElement('div');
            div.className = 'item-row';
            div.id = `row-${idLimpo}`;
            div.innerHTML = `
                <span class="item-name">${nomeServico}</span>
                <input type="number" class="item-price-input" value="${valorPadrao}" onchange="recalcularTotal()" onkeyup="recalcularTotal()">
            `;
            container.appendChild(div);
        } else {
            // Remove Linha
            const row = document.getElementById(`row-${idLimpo}`);
            if(row) row.remove();
            
            if(container.children.length === 0) boxContainer.classList.add('hidden');
        }
        recalcularTotal();
    }

    window.recalcularTotal = function() {
        let total = 0;
        const inputs = document.querySelectorAll('.item-price-input');
        inputs.forEach(inp => {
            total += parseFloat(inp.value) || 0;
        });
        document.getElementById('valorServico').value = total.toFixed(2);
    }

    // Preenche vindo do Rob√¥ (Adaptado)
    window.preencherLancamento = (cliente, servicoTexto) => {
        document.getElementById('clienteNome').value = cliente;
        
        // Limpa tudo
        document.querySelectorAll('.btn-service').forEach(btn => btn.classList.remove('active'));
        document.getElementById('listaItensEdicao').innerHTML = '';
        document.getElementById('containerItens').classList.add('hidden');
        
        const txt = servicoTexto.toLowerCase();
        
        // Ativa bot√µes inteligente
        if(txt.includes('corte') && !txt.includes('degrad√™')) document.getElementById('btn-corte').click();
        if(txt.includes('degrad√™')) document.getElementById('btn-degrade').click();
        if(txt.includes('barba')) document.getElementById('btn-barba').click();
        if(txt.includes('sobrancelha')) document.getElementById('btn-sobranc').click();
        if(txt.includes('pezinho')) document.getElementById('btn-pezinho').click();
        
        // Se nada, clica em Outro
        const inputs = document.querySelectorAll('.item-price-input');
        if(inputs.length === 0) document.getElementById('btn-outro').click();

        new bootstrap.Tab(document.querySelector('#lancar-tab')).show();
    }

    window.salvarServico = async (e) => {
        e.preventDefault();
        const prof = document.getElementById('profissionalSelect').value;
        const valTotal = parseFloat(document.getElementById('valorServico').value);
        
        // Constr√≥i string detalhada: "Corte (30) + Barba (25)"
        let descricaoDetalhada = [];
        const rows = document.querySelectorAll('.item-row');
        rows.forEach(row => {
            const nome = row.querySelector('.item-name').innerText;
            const preco = row.querySelector('.item-price-input').value;
            descricaoDetalhada.push(`${nome} (R$${preco})`);
        });
        const servicoFinal = descricaoDetalhada.join(' + ');

        let d = 0, f = 0;
        if(prof === 'Denver') { d = valTotal * 0.6; f = valTotal * 0.4; } else { f = valTotal; }

        await addDoc(colVendas, {
            profissional: prof, cliente: document.getElementById('clienteNome').value,
            servico: servicoFinal, total: valTotal,
            ganho_denver: d, ganho_fernando: f, data: Timestamp.now()
        });
        alert("‚úÖ Lan√ßado: " + servicoFinal);
        
        // Reset
        document.getElementById('clienteNome').value = '';
        document.getElementById('valorServico').value = '';
        document.querySelectorAll('.btn-service').forEach(btn => btn.classList.remove('active'));
        document.getElementById('listaItensEdicao').innerHTML = '';
        document.getElementById('containerItens').classList.add('hidden');
        
        new bootstrap.Tab(document.querySelector('#agenda-tab')).show();
    }

    function iniciarFinanceiro() {
        onSnapshot(query(colVendas, orderBy("data", "asc")), (snap) => {
            let td = 0, tf = 0;
            const tb = document.getElementById('listaHistorico');
            tb.innerHTML = '';
            snap.forEach(d => {
                const item = d.data();
                td += item.ganho_denver; tf += item.ganho_fernando;
                // Exibe Detalhado
                tb.innerHTML += `<tr>
                    <td>${item.profissional.substring(0,3)}</td>
                    <td><div style="font-weight:bold; color:white;">${item.cliente}</div><div style="font-size:0.75rem; color:#aaa;">${item.servico}</div></td>
                    <td class="text-end text-gold">R$${item.total}</td>
                </tr>`;
            });
            document.getElementById('saldoDenver').innerText = td.toFixed(0);
            document.getElementById('saldoFernando').innerText = tf.toFixed(0);
        });
    }

    // --- AGENDA E STATUS (MANTIDOS) ---
    function iniciarAgenda() {
        const hoje = getDataHoje();
        onSnapshot(query(colAgenda, where("data", "==", hoje)), (snapshot) => {
            const dadosAgenda = {};
            snapshot.forEach(docSnap => { dadosAgenda[docSnap.data().hora] = { id: docSnap.id, ...docSnap.data() }; });
            const horarios = ["09:00", "10:00", "11:00", "12:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00"];
            const div = document.getElementById('listaHorarios');
            div.innerHTML = '';

            horarios.forEach(h => {
                const ag = dadosAgenda[h];
                if (ag) {
                    if (ag.cliente === "BLOQUEADO PELO ADMIN") {
                        div.innerHTML += `<div class="slot-card slot-bloqueado"><div class="info-row"><span class="time-badge">${h}</span><button class="btn-block" onclick="cancelarAgendamento('${ag.id}', '${h}')"><i class="bi bi-unlock"></i> Abrir</button></div></div>`;
                    } else {
                        const tel = ag.telefone.replace(/\D/g, "");
                        const telFmt = tel.length>10 ? `(${tel.slice(0,2)}) ${tel.slice(2,7)}-${tel.slice(7)}` : tel;
                        div.innerHTML += `
                            <div class="slot-card slot-ocupado">
                                <div class="info-row mb-2">
                                    <span class="time-badge">${h}</span>
                                    <div>
                                        <button class="btn-launch" onclick="preencherLancamento('${ag.cliente}', '${ag.servico}')"><i class="bi bi-cash-coin"></i> Lan√ßar</button>
                                        <button class="btn-cancel" onclick="cancelarAgendamento('${ag.id}', '${h}')"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                                <div class="client-info">${ag.cliente}</div>
                                <div class="phone-info">${telFmt}</div>
                                <div class="service-info mt-1">${ag.servico}</div>
                            </div>`;
                    }
                } else {
                    div.innerHTML += `<div class="slot-card slot-livre"><div class="info-row"><span class="time-badge text-muted">${h}</span><button class="btn-block" onclick="bloquearHorario('${h}')"><i class="bi bi-lock"></i> Bloquear</button></div></div>`;
                }
            });
        });
    }

    window.bloquearHorario = async (hora) => { await addDoc(colAgenda, { data: getDataHoje(), hora: hora, cliente: "BLOQUEADO PELO ADMIN", telefone: "", servico: "Bloqueio Manual", status_pagamento: "Bloqueado", created_at: Timestamp.now() }); }
    window.cancelarAgendamento = async (id, hora) => { if(confirm(`Liberar hor√°rio das ${hora}?`)) await deleteDoc(doc(db, "agendamentos", id)); }
    function monitorarStatus() { onSnapshot(docConfig, (doc) => { const btn = document.getElementById('btnStatusLoja'); if (doc.exists() && doc.data().aberto) { btn.innerText = "ABERTO"; btn.className = "btn btn-sm status-toggle status-on"; } else { btn.innerText = "FECHADO"; btn.className = "btn btn-sm status-toggle status-off"; } }); }
    window.alternarStatusLoja = async () => { const btn = document.getElementById('btnStatusLoja'); const novo = btn.innerText.includes("FECHADO"); await setDoc(docConfig, { aberto: novo, mensagem: novo ? "Aberto!" : "Fechado." }); };
</script>
</body>
</html>
