<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barbearia Merigio - Gest√£o</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        :root {
            --gold-bright: #FFD700; 
            --bg-dark: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-white: #ffffff;
            --status-open: #00ff88;
            --status-closed: #ff4444;
        }
        body { background-color: var(--bg-dark); color: var(--text-white); font-family: 'Roboto', sans-serif; font-size: 16px; }
        
        /* Navbar */
        .navbar { background-color: #000; border-bottom: 2px solid var(--gold-bright); padding: 15px 0; }
        .navbar-brand { font-family: 'Montserrat', sans-serif; font-weight: 800; color: var(--gold-bright) !important; font-size: 1.4rem; text-transform: uppercase; }
        
        /* Cards */
        .card { background-color: var(--card-bg); border: 1px solid #444; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .form-control, .form-select { background-color: #fff !important; color: #000 !important; border: 2px solid #999; font-weight: 600; padding: 10px; border-radius: 8px; }
        .btn-gold { background-color: var(--gold-bright); color: #000; font-weight: 800; padding: 12px; border: none; width: 100%; text-transform: uppercase; }
        
        /* Abas */
        .nav-tabs .nav-link { color: #aaa; padding: 15px; }
        .nav-tabs .nav-link.active { background-color: transparent !important; color: var(--gold-bright) !important; border-bottom: 4px solid var(--gold-bright) !important; }
        
        /* STATUS LOJA */
        .status-toggle { font-size: 0.8rem; padding: 5px 12px; border-radius: 20px; border: 1px solid #555; cursor: pointer; font-weight: bold; }
        .status-on { background: var(--status-open); color: black; }
        .status-off { background: var(--status-closed); color: white; }

        /* AGENDA CARDS (Novo Design) */
        .slot-card { 
            background: #333; border: 1px solid #444; padding: 12px; margin-bottom: 12px; border-radius: 10px; 
            position: relative; overflow: hidden;
        }
        .slot-livre { border-left: 5px solid var(--status-open); }
        .slot-ocupado { border-left: 5px solid var(--status-closed); }
        
        .info-row { display: flex; justify-content: space-between; align-items: center; }
        .time-badge { font-size: 1.2rem; font-weight: 800; color: #fff; }
        .client-info { font-size: 0.9rem; color: #ddd; margin-top: 5px; }
        .service-info { font-size: 0.85rem; color: var(--gold-bright); font-weight: 600; }
        
        .btn-cancel { 
            background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid #ff4444; 
            padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; cursor: pointer;
        }
        .btn-cancel:hover { background: #ff4444; color: white; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav class="navbar sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0">BARBEARIA <span class="text-white">MERIGIO</span></span>
        <div id="lojaStatusContainer" class="hidden">
            <button id="btnStatusLoja" class="btn btn-sm status-toggle status-on" onclick="alternarStatusLoja()">ABERTO</button>
        </div>
    </div>
</nav>

<div class="container mt-3 pb-5">
    <div id="loginScreen" class="card p-4 mx-auto mt-4" style="max-width: 400px;">
        <div class="text-center mb-4"><h2 class="text-gold">LOGIN</h2></div>
        <form onsubmit="fazerLogin(event)">
            <div class="mb-3"><label class="text-muted small">EMAIL</label><input type="email" id="emailLogin" class="form-control" required></div>
            <div class="mb-4"><label class="text-muted small">SENHA</label><input type="password" id="senhaLogin" class="form-control" required></div>
            <button type="submit" class="btn btn-gold rounded-3">ACESSAR SISTEMA</button>
        </form>
    </div>

    <div id="mainPanel" class="hidden">
        <ul class="nav nav-tabs nav-fill mb-3" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#agenda">AGENDA BOT</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#lancar">LAN√áAR</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#relatorio">CAIXA</button></li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="agenda">
                <div class="card p-3">
                    <h5 class="text-white mb-3">Agenda de Hoje (WhatsApp)</h5>
                    <div id="listaHorarios">
                        <p class="text-center text-muted">Carregando agendamentos...</p>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="lancar">
                <div class="card p-3">
                    <form onsubmit="salvarServico(event)">
                        <div class="mb-3"><label class="text-gold fw-bold small">QUEM ATENDEU?</label>
                            <select id="profissionalSelect" class="form-select">
                                <option value="Fernando">üëë FERNANDO</option>
                                <option value="Denver">‚úÇÔ∏è DENVER</option>
                            </select>
                        </div>
                        <div class="mb-3"><label class="text-muted small">NOME CLIENTE</label><input type="text" id="clienteNome" class="form-control" required></div>
                        <div class="mb-3"><label class="text-muted small">SERVI√áO</label>
                            <select id="tipoServico" class="form-select">
                                <option value="Corte Degrad√™">Corte Degrad√™</option>
                                <option value="Corte Social">Corte Social</option>
                                <option value="Barba">Barba</option>
                                <option value="Combo">Cabelo + Barba</option>
                            </select>
                        </div>
                        <div class="mb-4"><label class="text-muted small">VALOR (R$)</label><input type="number" id="valorServico" class="form-control" step="0.01" required></div>
                        <button type="submit" class="btn btn-gold rounded-3 shadow">SALVAR CAIXA</button>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="relatorio">
                <div class="row g-2 mb-3">
                    <div class="col-6"><div class="card p-3 text-center border-success"><small class="fw-bold text-muted">DENVER</small><h3 class="text-success" id="saldoDenver">0</h3></div></div>
                    <div class="col-6"><div class="card p-3 text-center border-warning"><small class="fw-bold text-muted">FERNANDO</small><h3 class="text-warning" id="saldoFernando">0</h3></div></div>
                </div>
                <div class="card p-2">
                    <table class="table table-dark table-striped mb-0 table-sm"><tbody id="listaHistorico"></tbody></table>
                </div>
            </div>
        </div> 
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, deleteDoc, setDoc, onSnapshot, query, where, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    // --- CONFIGURA√á√ÉO ---
    const firebaseConfig = {
        apiKey: "AIzaSyDcIDq8AEmL48Z9IFy7-fzBTY6yiFTzTL4",
        authDomain: "appbarber-cf462.firebaseapp.com",
        projectId: "appbarber-cf462",
        storageBucket: "appbarber-cf462.firebasestorage.app",
        messagingSenderId: "252056091488",
        appId: "1:252056091488:web:8a483735cf8186ce24bc05"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const colVendas = collection(db, "lancamentos");
    const colAgenda = collection(db, "agendamentos");
    const docConfig = doc(db, "configuracao", "status_loja");

    // --- LOGIN ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainPanel').classList.remove('hidden');
            document.getElementById('lojaStatusContainer').classList.remove('hidden');
            iniciarAgenda();
            iniciarFinanceiro();
            monitorarStatus();
        }
    });

    window.fazerLogin = (e) => {
        e.preventDefault();
        signInWithEmailAndPassword(auth, document.getElementById('emailLogin').value, document.getElementById('senhaLogin').value).catch(err => alert("Erro no login: " + err.message));
    }

    // --- AGENDA COM CANCELAMENTO ---
    function iniciarAgenda() {
        const hoje = new Date().toISOString().split('T')[0];
        
        // Escuta as mudan√ßas no banco
        onSnapshot(query(colAgenda, where("data", "==", hoje)), (snapshot) => {
            
            // Mapeia os dados do banco
            const dadosAgenda = {};
            snapshot.forEach(docSnap => {
                dadosAgenda[docSnap.data().hora] = {
                    id: docSnap.id, // ID para poder deletar depois
                    ...docSnap.data()
                };
            });

            const horarios = ["09:00", "10:00", "11:00", "12:00"];
            const div = document.getElementById('listaHorarios');
            div.innerHTML = '';

            horarios.forEach(h => {
                const agendamento = dadosAgenda[h];
                
                if (agendamento) {
                    // SE ESTIVER OCUPADO
                    const telefoneFormatado = agendamento.telefone ? agendamento.telefone.replace('@c.us', '') : 'S/ Tel';
                    
                    div.innerHTML += `
                        <div class="slot-card slot-ocupado">
                            <div class="info-row mb-2">
                                <span class="time-badge">${h}</span>
                                <button class="btn-cancel" onclick="cancelarAgendamento('${agendamento.id}', '${h}')">
                                    <i class="bi bi-trash"></i> Cancelar
                                </button>
                            </div>
                            <div class="client-info">
                                <i class="bi bi-person-fill"></i> ${agendamento.cliente || 'Cliente Zap'}<br>
                                <i class="bi bi-whatsapp"></i> ${telefoneFormatado}
                            </div>
                            <div class="service-info mt-1">
                                <i class="bi bi-scissors"></i> ${agendamento.servico}
                            </div>
                        </div>`;
                } else {
                    // SE ESTIVER LIVRE
                    div.innerHTML += `
                        <div class="slot-card slot-livre">
                            <div class="info-row">
                                <span class="time-badge text-muted">${h}</span>
                                <span class="badge bg-success">LIVRE</span>
                            </div>
                            <div class="text-muted small mt-1">Dispon√≠vel para o Rob√¥</div>
                        </div>`;
                }
            });
        });
    }

    // --- FUN√á√ÉO DE CANCELAR (NOVA) ---
    window.cancelarAgendamento = async (id, hora) => {
        if(confirm(`Tem certeza que deseja cancelar o hor√°rio das ${hora}?\nIsso vai liberar o hor√°rio no Rob√¥.`)) {
            try {
                await deleteDoc(doc(db, "agendamentos", id));
                // N√£o precisa de alert, o onSnapshot atualiza a tela sozinho
            } catch (error) {
                alert("Erro ao cancelar: " + error.message);
            }
        }
    }

    // --- STATUS LOJA ---
    function monitorarStatus() {
        onSnapshot(docConfig, (doc) => {
            const btn = document.getElementById('btnStatusLoja');
            if (doc.exists() && doc.data().aberto) {
                btn.innerText = "ABERTO"; btn.className = "btn btn-sm status-toggle status-on";
            } else {
                btn.innerText = "FECHADO"; btn.className = "btn btn-sm status-toggle status-off";
            }
        });
    }

    window.alternarStatusLoja = async () => {
        const btn = document.getElementById('btnStatusLoja');
        const novoStatus = btn.innerText.includes("FECHADO");
        await setDoc(docConfig, { aberto: novoStatus, mensagem: novoStatus ? "Aberto!" : "Fechado." });
    };

    // --- FINANCEIRO ---
    window.salvarServico = async (e) => {
        e.preventDefault();
        const prof = document.getElementById('profissionalSelect').value;
        const val = parseFloat(document.getElementById('valorServico').value);
        let d = 0, f = 0;
        if(prof === 'Denver') { d = val * 0.6; f = val * 0.4; } else { f = val; }

        await addDoc(colVendas, {
            profissional: prof, cliente: document.getElementById('clienteNome').value,
            servico: document.getElementById('tipoServico').value, total: val,
            ganho_denver: d, ganho_fernando: f, data: Timestamp.now()
        });
        alert("Caixa atualizado!");
        document.getElementById('clienteNome').value = '';
        document.getElementById('valorServico').value = '';
    }

    function iniciarFinanceiro() {
        onSnapshot(query(colVendas, orderBy("data", "asc")), (snap) => {
            let td = 0, tf = 0;
            const tb = document.getElementById('listaHistorico');
            tb.innerHTML = '';
            const itens = [];
            snap.forEach(d => itens.push(d.data()));
            itens.reverse().forEach(i => {
                td += i.ganho_denver; tf += i.ganho_fernando;
                tb.innerHTML += `<tr><td>${i.profissional.substring(0,3)}</td><td>${i.cliente}</td><td class="text-end">R$${i.total}</td></tr>`;
            });
            document.getElementById('saldoDenver').innerText = td.toFixed(0);
            document.getElementById('saldoFernando').innerText = tf.toFixed(0);
        });
    }
</script>
</body>
</html>
