<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BarberApp - Fernando & Denver</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-gold: #D4AF37;
            --bg-dark: #121212;
            --card-dark: #1E1E1E;
            --text-light: #ffffff;
            --text-muted: #cccccc;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Open Sans', sans-serif;
            font-size: 16px;
        }

        /* Navbar */
        .navbar {
            background: #1E1E1E;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            padding: 15px 0;
            z-index: 1000;
        }
        .navbar-brand {
            color: var(--primary-gold) !important;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
        }

        .main-container {
            margin-top: 20px;
            padding-bottom: 80px;
        }

        /* Cards e Inputs */
        .card {
            background-color: var(--card-dark);
            border: 1px solid #333;
            border-radius: 12px;
        }

        label { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }

        .form-control, .form-select {
            background-color: #2C2C2C;
            border: 1px solid #444;
            color: #fff !important;
            font-size: 1rem;
            border-radius: 8px;
            padding: 12px;
        }
        .form-control:focus, .form-select:focus {
            background-color: #333;
            border-color: var(--primary-gold);
            color: #fff !important;
            box-shadow: none;
        }

        /* Bot√µes */
        .btn-gold {
            background: var(--primary-gold);
            border: none;
            color: #000;
            font-weight: 700;
            text-transform: uppercase;
        }
        .btn-gold:hover { background: #b59024; color: #000; }

        /* Abas */
        .nav-tabs { border-bottom: 1px solid #333; margin-bottom: 20px; }
        .nav-link { 
            color: var(--text-muted); 
            border: none; 
            font-weight: 600; 
            padding: 12px;
        }
        .nav-link.active {
            background-color: transparent !important;
            color: var(--primary-gold) !important;
            border-bottom: 3px solid var(--primary-gold) !important;
        }

        /* Badges de Profissional */
        .badge-fernando { background-color: var(--primary-gold); color: #000; }
        .badge-denver { background-color: #28a745; color: #fff; }

        /* Utilit√°rios */
        .hidden { display: none !important; }
        .text-gold { color: var(--primary-gold) !important; }
        .table { --bs-table-color: var(--text-muted); }
        .table-dark { --bs-table-bg: #252525; }
        
        /* Anima√ß√£o */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
        <span class="navbar-brand mb-0"><i class="bi bi-scissors"></i> Barber<span class="text-white">App</span></span>
        <button id="btnSair" class="btn btn-outline-light btn-sm rounded-pill px-3 hidden" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Sair
        </button>
    </div>
</nav>

<div class="container main-container">

    <div id="loginScreen" class="card p-4 mx-auto mt-5" style="max-width: 400px;">
        <div class="text-center mb-4">
            <h1 class="text-gold"><i class="bi bi-shield-lock"></i></h1>
            <h4>Acesso Restrito</h4>
            <p class="text-muted small">Login do sistema</p>
        </div>
        
        <form onsubmit="fazerLogin(event)">
            <div class="mb-3">
                <label>Email</label>
                <input type="email" id="emailLogin" class="form-control" placeholder="admin@barber.com" required>
            </div>
            <div class="mb-4">
                <label>Senha</label>
                <input type="password" id="senhaLogin" class="form-control" placeholder="******" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-gold py-3 rounded-pill shadow">Entrar</button>
            </div>
            <div id="loginError" class="text-danger text-center mt-3 small hidden"></div>
        </form>
    </div>

    <div id="mainPanel" class="hidden fade-in">
        
        <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="lancar-tab" data-bs-toggle="tab" data-bs-target="#lancar" type="button" role="tab">
                    <i class="bi bi-plus-circle"></i> Lan√ßar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="relatorio-tab" data-bs-toggle="tab" data-bs-target="#relatorio" type="button" role="tab">
                    <i class="bi bi-graph-up"></i> Caixas
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="chatbot-tab" data-bs-toggle="tab" data-bs-target="#chatbot" type="button" role="tab">
                    <i class="bi bi-whatsapp"></i> Bot <span id="chatBadge" class="badge bg-danger rounded-pill ms-1">0</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="lancar" role="tabpanel">
                <div class="card p-4">
                    <h5 class="mb-3 text-gold border-bottom border-secondary pb-2">Novo Atendimento</h5>
                    <form onsubmit="salvarServico(event)">
                        
                        <div class="mb-3">
                            <label class="text-warning">Quem cortou?</label>
                            <select id="profissionalSelect" class="form-select form-select-lg" style="border: 2px solid #555;">
                                <option value="Fernando">üëë Fernando (Dono)</option>
                                <option value="Denver">‚úÇÔ∏è Denver (Colaborador)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Cliente</label>
                            <input type="text" id="clienteNome" class="form-control" placeholder="Nome do cliente..." required>
                        </div>
                        <div class="mb-3">
                            <label>Servi√ßo</label>
                            <select id="tipoServico" class="form-select">
                                <option value="Corte Degrad√™">Corte Degrad√™</option>
                                <option value="Corte Social">Corte Social</option>
                                <option value="Barba">Barba</option>
                                <option value="Corte + Barba">Corte + Barba</option>
                                <option value="Sobrancelha">Sobrancelha</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label>Valor (R$)</label>
                            <input type="number" id="valorServico" class="form-control" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-gold py-3 rounded-pill">Salvar Lan√ßamento</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="relatorio" role="tabpanel">
                
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="card p-3 text-center bg-dark border-success h-100">
                            <small class="text-success fw-bold">SALDO DENVER</small>
                            <div class="small text-muted mb-1">(60% Comiss√µes)</div>
                            <h3 class="text-white">R$ <span id="saldoDenver">0.00</span></h3>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card p-3 text-center bg-dark border-warning h-100">
                            <small class="text-gold fw-bold">SALDO FERNANDO</small>
                            <div class="small text-muted mb-1">(Cortes Pr√≥prios + 40%)</div>
                            <h3 class="text-white">R$ <span id="saldoFernando">0.00</span></h3>
                        </div>
                    </div>
                </div>

                <div class="card p-3">
                    <h6 class="text-white mb-3">Hist√≥rico de Hoje</h6>
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-sm align-middle mb-0">
                            <thead>
                                <tr class="text-muted small">
                                    <th>Profis.</th>
                                    <th>Cli.</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="listaHistorico">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="chatbot" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-white mb-0">Fila WhatsApp</h5>
                    <span class="badge bg-success">Online</span>
                </div>
                <div id="chatbotList" class="list-group">
                    </div>
            </div>

        </div> 
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    // --- CONFIGURA√á√ÉO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDcIDq8AEmL48Z9IFy7-fzBTY6yiFTzTL4",
        authDomain: "appbarber-cf462.firebaseapp.com",
        projectId: "appbarber-cf462",
        storageBucket: "appbarber-cf462.firebasestorage.app",
        messagingSenderId: "252056091488",
        appId: "1:252056091488:web:8a483735cf8186ce24bc05",
        measurementId: "G-8L2WJPVW6G"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const colecaoVendas = collection(db, "lancamentos");

    // Login State
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainPanel').classList.remove('hidden');
            document.getElementById('btnSair').classList.remove('hidden');
            iniciarEscutaEmTempoReal();
            carregarChatbotMock();
        } else {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainPanel').classList.add('hidden');
            document.getElementById('btnSair').classList.add('hidden');
        }
    });

    window.fazerLogin = function(e) {
        e.preventDefault();
        const email = document.getElementById('emailLogin').value;
        const pass = document.getElementById('senhaLogin').value;
        const errorMsg = document.getElementById('loginError');

        errorMsg.classList.add('hidden');
        signInWithEmailAndPassword(auth, email, pass)
            .catch((error) => {
                errorMsg.innerText = "Erro: " + error.message;
                errorMsg.classList.remove('hidden');
            });
    }

    window.logout = function() {
        signOut(auth).then(() => location.reload());
    }

    // --- SALVAR COM REGRA DE COMISS√ÉO ---
    window.salvarServico = async function(e) {
        e.preventDefault();
        
        const profissional = document.getElementById('profissionalSelect').value; // Fernando ou Denver
        const cliente = document.getElementById('clienteNome').value;
        const servico = document.getElementById('tipoServico').value;
        const valorTotal = parseFloat(document.getElementById('valorServico').value);

        if(!cliente || !valorTotal) return;

        let ganhoDenver = 0;
        let ganhoFernando = 0;

        // REGRA DE NEG√ìCIO
        if (profissional === "Denver") {
            // Se Denver cortou: 60% dele, 40% Fernando
            ganhoDenver = valorTotal * 0.60;
            ganhoFernando = valorTotal * 0.40;
        } else {
            // Se Fernando cortou: 100% Fernando (Dono)
            ganhoDenver = 0;
            ganhoFernando = valorTotal;
        }

        try {
            await addDoc(colecaoVendas, {
                profissional: profissional,
                cliente: cliente,
                servico: servico,
                total: valorTotal,
                ganho_denver: ganhoDenver,
                ganho_fernando: ganhoFernando,
                data: Timestamp.now()
            });
            
            alert(`‚úÖ Lan√ßado para ${profissional}!`);
            document.getElementById('clienteNome').value = '';
            document.getElementById('valorServico').value = '';
            document.getElementById('clienteNome').focus();

        } catch (error) {
            alert("Erro ao salvar: " + error.message);
        }
    }

    // --- RELAT√ìRIO INTELIGENTE ---
    function iniciarEscutaEmTempoReal() {
        const q = query(colecaoVendas, orderBy("data", "asc"));

        onSnapshot(q, (snapshot) => {
            let saldoD = 0;
            let saldoF = 0;
            const tbody = document.getElementById('listaHistorico');
            tbody.innerHTML = '';

            const vendas = [];
            snapshot.forEach((doc) => vendas.push({ id: doc.id, ...doc.data() }));

            vendas.reverse().forEach(item => {
                // Soma os ganhos individuais salvos no banco
                saldoD += item.ganho_denver || 0;
                saldoF += item.ganho_fernando || 0;

                // Define cor do badge
                let badgeClass = item.profissional === 'Fernando' ? 'badge-fernando' : 'badge-denver';
                let nomeProf = item.profissional === 'Fernando' ? 'FER' : 'DEN';

                let row = `<tr>
                    <td><span class="badge ${badgeClass}">${nomeProf}</span></td>
                    <td class="text-white small">${item.cliente}<br><span class="text-muted" style="font-size:0.75rem">${item.servico}</span></td>
                    <td class="text-gold">R$${item.total.toFixed(0)}</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            document.getElementById('saldoDenver').innerText = saldoD.toFixed(2);
            document.getElementById('saldoFernando').innerText = saldoF.toFixed(2);
        });
    }

    // --- MOCK CHATBOT ---
    window.carregarChatbotMock = function() {
        const pedidos = [
            { cliente: "Carlos", servico: "Corte", hora: "14:30" },
            { cliente: "Pedro", servico: "Barba", hora: "15:00" }
        ];
        const lista = document.getElementById('chatbotList');
        const badge = document.getElementById('chatBadge');
        if(lista) {
            lista.innerHTML = '';
            pedidos.forEach(p => {
                lista.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                        <div><div class="fw-bold text-white">${p.cliente}</div><div class="small text-muted">${p.servico}</div></div>
                        <button class="btn btn-sm btn-outline-success" onclick="importarPedido('${p.cliente}')">Lan√ßar</button>
                    </div>`;
            });
            badge.innerText = pedidos.length;
        }
    }

    window.importarPedido = function(nome) {
        document.getElementById('clienteNome').value = nome;
        const triggerEl = document.querySelector('#lancar-tab');
        const tab = new bootstrap.Tab(triggerEl);
        tab.show();
    }
</script>

</body>
</html>
